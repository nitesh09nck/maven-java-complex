# ☸️ JOB 4: Deploy to Kubernetes + Integration Tests
deploy:
  name: Deploy to Kubernetes (kind) and Run Integration Tests
  runs-on: ubuntu-latest
  needs: docker
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Download JAR artifact for Docker build
    - name: Download built JAR
      uses: actions/download-artifact@v4
      with:
        name: app-jar
        path: target/

    # Set up kind cluster
    - name: Set up kind cluster
      uses: engineerd/setup-kind@v0.5.0
      with:
        version: v0.20.0

    # Build Docker image for kind
    - name: Build Docker image for kind
      run: docker build -t java-project:latest .

    # Load Docker image into kind
    - name: Load Docker image into kind
      run: kind load docker-image java-project:latest

    # Apply manifests (make sure deployment.yaml references image: java-project:latest)
    - name: Deploy manifests
      run: |
        # Optional: temporarily remove readiness/liveness probes for CI
        sed -i '/readinessProbe:/,+5d' k8s/deployment.yaml || true
        sed -i '/livenessProbe:/,+5d' k8s/deployment.yaml || true

        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml || echo "⚠️ No HPA configured"

    # Wait for deployment to be ready
    - name: Wait for Deployment rollout
      run: |
        kubectl rollout status deployment/java-project-deployment --timeout=180s
        kubectl get pods -o wide

    # Wait for service endpoints
    - name: Wait for Service endpoints
      run: |
        SERVICE_NAME=java-project
        for i in {1..12}; do
          ENDPOINTS=$(kubectl get endpoints $SERVICE_NAME -o jsonpath='{.subsets[0].addresses[*].ip}' 2>/dev/null || echo "")
          if [ -n "$ENDPOINTS" ]; then
            echo "Service $SERVICE_NAME ready with endpoints: $ENDPOINTS"
            break
          fi
          echo "Waiting for service endpoints..."
          sleep 5
        done

    # Debug pod logs if rollout fails
    - name: Debug pod logs
      if: failure()
      run: |
        kubectl get pods -o wide
        kubectl describe pods
        for POD in $(kubectl get pods -l app=java-project -o jsonpath='{.items[*].metadata.name}'); do
          echo "Logs for pod $POD:"
          kubectl logs $POD || echo "No logs yet"
        done

    # Optional: Check HPA status
    - name: Verify HPA
      run: kubectl get hpa || echo "⚠️ No HPA configured"

    # ✅ Integration Tests against deployed app
    - name: Run Integration Tests
      run: |
        NODE_PORT=$(kubectl get svc java-project -o jsonpath='{.spec.ports[0].nodePort}')
        echo "Testing service at http://localhost:$NODE_PORT/health"
        curl -f http://localhost:$NODE_PORT/health || exit 1
